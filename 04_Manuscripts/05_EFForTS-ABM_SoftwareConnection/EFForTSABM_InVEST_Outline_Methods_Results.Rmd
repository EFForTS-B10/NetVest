---
title: "Integration of the model InVEST with the model EFForTS-ABM: new tool for dynamic simulation of biodiversity and economic functions"

author: 
  - Julia Henzler:
      email: julia.henzler@uni-goettingen.de
      institute: [affil1]
      correspondence: true
      contribution: conceptual work, parameter setting, integration and acceptance test, analysis, manuscript writing
  - Nils Beyer:
      email: nils.beyer@posteo.de
      institute: [affil1]
      correspondence: false
      contribution: technical assistant, realization of docker file, singularity container, unit tests, conceptual work for executing unit tests
  - Sebastian Hanss:
      email: sebastian.hanss@uni-goettingen.de
      institute: [affil1]
      correspondance: false
      contribution: conceptual work for docker file and singularity container
  - Craig Eric Simpkins:
      email: craig.simpkins@uni-goettingen.de
      institute: [affil1]
      correspondence: false
      contribution: manuscript writing
  - Jan Salecker:
      email: jan.saleck@posteo.de
      institute: [affil1]
      correspondence: false
      contribution: conceptual work
  - Kerstin Wiegand:
      email: kerstin.wiegand@uni-goettingen.de
      institute: [affil1]
      correspondence: false
      contribution: conceptual work, manuscript writing
institute:
  - affil1: University of Goettingen, Department of Ecosystem Modelling, Buesgenweg 4, 37077 Goettingen
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/word-styles-reference01.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: IntegrationPaper.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style

---
```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../../03_Analyses/10_landmarket_wages_v6/figures/",
  dpi = 300
)
```
**Keywords:** biodiversity, ecological functions, economic functions, EFForTS-ABM, InVEST, software integration

**Running headline:** Integration of InVEST with EFForTS-ABM (34 characters)

**Alternative titles:**

* "Integration of static model with dynamic model"

* "Integration of the model InVEST with the model EFForTS-ABM"

* "Integration of biodiversity model with land-use change model"

* "Dynamic simulation of biodiversity and socio-economic functions simultaneously: Integration of the model InVEST with the model EFForTS-ABM."

* "Integration of the model InVEST with the model EFForTS-ABM: new tool for dynamic simulation of biodiversity and socio-economic functions simultaneously"

* "Integration of InVEST with EFForTS-ABM: new tool for dynamic simulation of biodiversity and economic functions"

* "Integration of InVEST with EFForTS-ABM: dynamic simulation of biodiversity and economic functions"

<br>

**Author contributions:**

JH, NB, SH, JS and KW conceived the ideas and designed methodology, JH and NB analyzed the data, JH, CS and KW led the writing of the manuscript. All authors contributed critically to the drafts and gave final approval for publication.

<br>

**Target Journals:** Methods in Ecology and Evolution, PLOS Computational Biology, Ecological Modeling

<br>

**Key message:** Demonstration of the integration of the static terrestrial biodiversity model InVEST with the dynamic land-use change model EFForTS-ABM. As a result, synergies and trade-offs between biodiversity and socio-economic functions can be assessed simultaneously and dynamically at multiple temporal and spatial scales.

# Abstract

The Abstract must not exceed 350 words and should list the main results and conclusions, using simple, factual, numbered statements:

Point 1: set the context for and purpose of the work;

Point 2: indicate the approach and methods;

Point 3: outline the main results;

Point 4: identify the conclusions and the wider implications.


# Introduction
*	Relationship between ecological and socio-economic functions for conservation issues
    +	Ecological and socio-economic sphere (biodiversity as key index)
    +	Trade-offs and Synergies and possible problems when unbalanced
    +	Open question: Unclear relationship over time and space and the consequence for conservation

*Rethink the audience and address first paragraph of introduction accordingly.*

*	Representation of both models separately and their issues 
    + Models are capable of examining relationships over multiple temporal and spatial scales....
    + InVEST was developed for changes of ecosystems at different spatial and temporal scales but is a static model (as only 2 different points in time can be compared, not development across time). Rapid assessment of biodiversity patterns and status : ecological functions + biodiversity via ecological production functions, static model, proven model: examples of applications 
    +	EFForTS-ABM is a land-use change model where landscape is managed: socio-economic function, dynamic model

*	Benefits of connection of EFForTS-ABM and InVEST:
    +	EFForTS-ABM can be used as dynamic input for InVEST
    +	EFForTS-ABM fits requirements to generate input for InVEST 
    +	Output of InVEST can be processed dynamically within EFForTS-ABM

*	Aim and Hypotheses
    +	Aim: Tool for simultaneously model socio-economic functions and biodiversity over time and space
    +	Connection is possible through narrow integrationlayer it can be easily implemented, maintained and comprehended (maybe to Abstract).	


# Methods

## Integration of InVEST with EFForTS-ABM 

For the simultaneous simulation of biodiversity and socio-economic functions within a single analysis we integrated the model EFForTS-ABM with the model InVEST. EFForTS-ABM generated the land-use and land-cover maps (LULC-maps), the impact-maps and the parameter settings used as input for the model InVEST. InVEST calculated the habitat quality for further processing within EFForTS-ABM. We developed functional and non-functional requirements for testing correct implementation. 
*Mention at first in intro or at first in methods?*

The static production function model InVEST-Terrestrial Biodiversity (Version 3.9, Tier 1) was used to simulate biodiversity [@kareiva_natural_2012]. The model is spatially-explicit and calculates a grid-cell level degradation score and a grid-cell level habitat-quality score for every grid cell which was assigned suitable habitat. Suitable habitat depends on the selected research objective (general biodiversity, species-specific needs). The degradation score depends on proximity of habitat-types to user-defined impacts to biodiversity. The calculation is based (i) on distribution of land use and land cover (LULC-map) for the area of interest, (ii) on distribution and intensity of user-defined impacts to biodiversity (impact-maps), (iii) on the assignment of suitable habitats and their sensitivity to impacts (sensitivity-table) and (iv) on relative impact weighting and how quickly the impact decays over space (impact-table). For a full description of the calculation read [@sharp_r_invest_nodate]. The degradation score is then standardized to a grid cell-level habitat quality score (Figure \@ref(fig:invest)) via a half-saturation function. Resulting in a degradation-map and a quality-map as input for EFForTS-ABM. The habitat-quality score is a proxy for biodiversity based on a simple habitat-analysis, enabling rapid assessment of biodiversity patterns. InVEST is a scientifically grounded tool and is verified as a widely applied software tool for simulation of biodiversity and ecological functions based on spatially-explicit maps. A detailed user guide was published in @sharp_r_invest_nodate.

<br>

```{r invest, out.width = "100%", fig.cap = "**InVEST-Terrestrial Biodiversity.** Calculation of grid cell-level degradation score and grid cell-level habitat quality score"}
knitr::include_graphics(file.path("figures/png/InVEST.png"))
```

<br>

To simulate the socio-economic component of the analysis, the dynamic land-use change model EFForTS-ABM (version xyz) was used. The initial landscapes for EFForTS-ABM are generated with the landscape generator EFForTS-LGraf. Landscapes are comprised of regular grid cells of 100 x 100 cells with a dimension of 50 m x 50 m, summing up a total landscape dimension of 25km^2^. They represent a forested landscape in Sumatra (Indonesia) with roads and villages of smallholder farming household agents and agricultural fields (oilpalm and rubber) owned and farmed by individual households. Every year households make rational land-use decisions with the aim to maximize their economic benefit (Figure\@ref(fig:abm) ). Detailed descriptions of EFForTS-LGraf and EFForTS-ABM were published in @salecker_efforts-lgraf_2019 and @dislich_land-use_2018, respectively. EFForTS-ABM is able to investigate how decisions of smallholders affect economic functions (e.g. household consumption) and landscape structure from a local to a landscape scale and vice versa at various points in time. The ABM comprises a spatially-explicit landscape with assignment of land use (management) and land cover (oilpalm, rubber, forest, village) to each grid cell. The impacts to biodiversity (from either land use or land cover) can easily be derived from EFForTS-ABM. The ABM is also suitable to integrate the generated habitat quality maps from InVEST. Therefore, EFForTS-ABM fits requirements for dynamically generate the input for InVEST and dynamically process the output of InVEST.

<br>

```{r abm, out.width = "100%", fig.cap = "**EFForTS-ABM.** Yearly land-use and land management decision of households."}
knitr::include_graphics(file.path("figures/png/Economic_simple.png"))
```

<br>

The implementation of both models was achieved by an two-way Input-Output-Transfer. We mapped the outputs from EFForTS-ABM as the inputs to InVEST and mapped the outputs from InVEST as the inputs EFForTS-ABM. First, EFForTS-ABM generates (i) the LULC-map and  (ii) one impact-map for each defined impact, (iii) the corresponding sensitivity-table and (iv) impact-table. The LULC-map and the impact-maps are in Tag Image File format (tif-format) and the sensitivity-table and impact-table are in comma-seperated value format (csv-format). Second, InVEST integrates the generated inputs of EFForTS-ABM and calculates the habitat-degradation map and habitat-quality map in tif-format for further processing in EFForTS-ABM (Figure\@ref(fig:transfer)). Since EFForTS-ABM is only able to process asc-format and InVEST is only able to process tif-format, asc- and tif-formats were converted by Geospatial Data Abtraction Library (Version xyz depending on InVEST-Version, @gdal).

<br>

```{r transfer, out.width = "100%", fig.cap = "**Input-Output-Transfer between EFForTS-ABM and InVEST**. The input of InVEST (LULC-map, Impact-map, Sensitivity-table, Impact-table) are generated by EFForTS-ABM. The input of EFForTS-ABM (Habitat-Degradation-map, Habitat-Quality-map) are generated by InVEST. For the transfer a converter is needed."}
knitr::include_graphics(file.path("figures/png/Input-Output-Transfer.png"))
```

<br>

## Evaluation of integration of InVEST with EFForTS-ABM

To evaluate the integration between the static production function model InVEST and the dynamic land-use change model EFForTS-ABM, we adopted a widely applied software testing system as our requirement plan [@bashar_requirements_2000]. This plan was divided into functional and non-functional requirements.

The functional requirements included a testing scheme beginning from unit-tests to integration-tests and ending with an acceptance-test [@a_contan_test_2018]. Unit-tests were applied to verify the correct implementation of processes. This was realized by an isolated unit-testing module within EFForTS-ABM. This module comprised each particular process implemented by the integration of InVEST with EfforTS-ABM. We compared the simulated output of each particular process to its expected output (Table A in Supplementary Materials). Integration-tests were applied to verify the correct integration between InVEST and EFForTS-ABM. This could be proven by correct Input-Output-Processing. It was realized by an isolated integration-testing module within EFForTS-ABM. For more convenient comparison of results, we chose a simplified parameter setting (see table 1 and table 2) - with binary approaches for all assignment of values (habitat, sensitivity, intensity of impacts, impact weighting) - and two simplified landscapes - forest-landscape and single-field-landscape. First, to verify the correct calculation of habitat-quality scores, the simulated grid cell-level habitat quality scores for the forest-landscape were compared to the expected output. Second, the simulated grid cell-level habitat-quality scores for the single-field-landscape were compared to the expected output to verify the correct reduction of habitat quality scores by the defined impacts.

<br>

```{r sensitivty table,echo=FALSE}
#Create dataframe from txt file
sensitivity <- read.table("tables\\sensitivitytable_integrationtest.txt", header = TRUE)
sens <- data.frame(sensitivity)

#Create table
pander::pander(sens, caption = 'Table 1: **Sensitivity table.** Classification (LULC) and names (NAMES) of LULC-types and their corresponding habitat assignment (HABITAT) and sensitivities to defined impacts (L_oilpalm, L_rubber). ')
```

<br>

```{r impact table,echo=FALSE}
#Create dataframe from txt file
impact <- read.table("tables\\impacttable_integrationtest.txt", header = TRUE)
imp <- data.frame(impact)

#Create table
pander::pander(imp, caption = 'Table 2: **Impact table.** Maximal distance of each impact over space (MAX_DIST in km), its corresponding impact weighting (WEIGHT) and how impacts decay over space (DECAY). ')
```

<br>

The acceptance-test was applied to verify the dynamic simulation of socio-economic functions and biodiversity simultaneously. This test represents a constant price scenario without learning and without any landmarket. The landscape is parameterized with data from a lowland rainforest transformation system in Sumatra, Indonesia. Parameter setting for InVEST is shown in tables 1 and 2. Parameter setting for EFForTS-ABM is shown in table 3. The household consumption of all households was analyzed as one representative for socio-economic-functions. The landscape-level habitat quality score, which is a aggregation of all grid cell-level habitat quality scores, was analyzed as the representative for biodiversity. Each test was executed with the R package nlrx (version xyz)[@salecker_nlrx_2019].

<br>

```{r Parameter setting EFForTS-ABM, echo=FALSE}
#Create dataframe
para_efforts <- data.frame(Parameters = c("Prices", "Learning", "Inefficiency", "which-map", "land-use-change-decision", "initial-wealth-distribution", "landmarket", "biodiv_plants", "biodiv_plants_objective"),
                 Value = c("constant prices", "no learning", "no inefficiency", "five-farmers2", "only-one-field-per-year", "constant", "no landmarket", "invest_pyhton", "general")
                 )

#Create table
pander::pander(para_efforts, caption = 'Table 3: **Parameter setting for EFForTS-ABM** (Maybe move to Supplementary Materials) ')
```

The non-functional requirements include the reproducibility of the integrated EFForTS-ABM-InVEST software tool. Simulations can be executed on a linux-server or on a high-performance-cluster with a uniform software management, a shared batch management environment, cross-system monitoring and accounting, and cross-system file systems. The simulations were executed with the R Package nlrx and submitted to the high-performance-cluster by the R package clustermq (version xyz, @schubert_clustermq_2019). For the execution of the simulations on a server, we designed a repository on github. It includes setup instructions and a dockerfile with the correct version of InVEST and its required dependencies along with an R-Studio-Server for execution of simulations. For the execution of the simulations on a high-performance-cluster, we designed a singularity container, which duplicates the dockerfile into a singularityfile on the cluster. *Here, we have to wait for further progress. Actually, there is no function within cluster_mq to run a singularity container on the hpc. We opened an issue and wait for response. If there is no convenient way to run singularity on hpc, we have to work with an manual installation of InVEST on the cluster.*


# Results

## Integration of InVEST with EFForTS-ABM

The integration was achieved by extending EFForTS-ABM with the biodiversity submodel (Figure\@ref(fig:architecture)). First, the input for InVEST (i)-(iv) is generated within EFForTS-ABM. At initialization (1) the model InVEST - Terrestrial Biodiversity is set up and (2) depending on research objective (general biodiversity or species-specific needs) the sensitivity table and impact-table are generated. Every year the ABM (3) generates the LULC-map and the corresponding impact-maps which are (4) stored as tif-files after conversion. Second, the habitat quality is calculated within EFForTS-ABM. Every year the ABM (5) invokes InVEST and transfers the previous generated output (i)-(iv). Based on the transferred output (7) the model InVEST calculates the Habitat-Degradation map and Habitat-Quality map. Within EFForTS-ABM (8) the maps are converted and (9) the habitat-quality scores of the Habitat-Quality map are stored in the grid cells of the landscape of EFForTS-ABM as an additional landscape property. Finally, the ABM (10) aggregates the grid-cell level habitat-quality scores to (10) to a landscape-level habitat-quality score. 

```{r architecture, out.width = "10%", out.height = "10%", fig.cap = "**Software-Architecture:** Implementation of the biodiversity submodel within EFForTS-ABM and corresponding processes involved in the integration of InVEST with EFForTS-ABM. *keep numbers for processes and also present them in figure?*"}
knitr::include_graphics(file.path("figures/png/Software-Architecture.png"))
```


## Evaluation of integration of InVEST with EFForTS-ABM

We confirmed all evaluated functional requirements stated in our requirement plan for correct integration of InVEST with EFForTS-ABM. The correct implementation of processes was verified, as the expected output of each particular process equaled its simulated output (Table 1, Supplementary Materials). The correct integration of both models was verified, as the correct calculation of habitat-quality and correct reduction of habitat-quality by impacts was shown. Within the forest-landscape all grid cells showed the highest possible habitat-quality score of 1. For the single-field-landscape, the habitat-quality score of the agricultural field showed the highest reduction of habitat-quality (value x). The neighboring forest grid cells in radius of 50 m showed less reduction of habitat quality (value x). All other forest grid-cells showed no reduction of habitat-quality (Habitat-quality score = 1), as the greatest distance of all impacts is 50 m. The dynamic and simultaneously simulation of socio-economic functions and biodiversity was achieved. Our results showed the the yearly household consumption and yearly biodiversity (landscape-level habitat-quality score) over the simulated time within one single analysis (Figure 5). 

![Figure 5 (Coming soon): **Dynamic simulation of economic function and biodiversity simultaneously.** Mean household consumption in USD (red) and mean landscape-level habitat quality (green) over time. The dark lines refer to mean values of the 20 model replications and the shaded polygon surrounding each line refers to the respective standard deviations.]   


The non-functional requirements for reproducibility were achieved by a docker-file and a singularity container. The docker-file can be accessed on our github repository [<https://github.com/nilsbeyer/rstudio-docker>]. *Also describe in detail the setup instruction and content of docker-file, which is listed in repository or is it enough to refer to repository?*

singularity container (wait for description of results, until we know if it works or not)




# Discussion
*	Possible points to discuss
    +	Benefit of connection instead of usage separately (dynamic simulations, feedback between economic functions and biodiversity,….)
    +	Reference to Acceptance Test
    + Comparison of ABM and InVEST with table (classification of models) and point to important difference
*	Conclusions
    +	Easy implementation, easy adjusting to different models
    +	New tool for assessing socio-economic functions simultaneously with ecological functions and biodiversity over time and space 
	  + flexible:extend to Tier 2 with incooperation of species-specific data
	  
# Acknowledgements
Funded by the Deutsche Forschungsgemeinschaft (DFG, German Research Foundation) – project number 192626868 – SFB 990 in the framework of the collaborative German-Indonesian research project CRC 990. We thank Matthias Christian Spangenberg for valuable feedback on a earlier version of the manuscript.	

# Supplementary material
*	Include more detailed Software-Architecture with every in- and output of both models (especially for economic submodel of EFForTS-ABM)

```{r result unit-tests, echo=FALSE}
#Create dataframe
unittest <- data.frame(Processes = c("set-up-invest", "write-tables", "translate-lulc-to-invest", "write-maps", "convert-maps", "run-invest", "convert-habitat-quality-to-asc", "save-habitat-quality-to-patch", "aggregate-habitat-quality"),
                       Input = c("which-machine? = server", "dummy sensitivity table, dummy impact-table", "p_landuse and p_homebase", "patch-raster of p_landuse_invest and patch-raster of p_landuse_invest 2/3", "lulc.asc, rubber_c.asc, oilpalm_c.asc", "half-saturation-constant, working directory, path to lulc-map and tables, determination of impact_raster_folder", "quality_c_test.tif", "quality_c_test.asc", "sum of p_habitat-quality values" ),
                 Expected = c("setting up python invest", "sensitivity_table.csv and impact_table.csv in output folder", "forest: p_landuse_invest = 4, rubber: p_landuse_invest = 3, oilpalm: p_landuse_invest = 2, village:p_landuse_invest = 1", "lulc.asc, rubber_c.asc and oilpalm_c.asc in output folder", "lulc.tif, rubber_c.tif and oilpalm_c.tif in output folder", "quality_c_test.tif in output folder", "quality_c_test.asc in output folder", "p_habitat_quality {0,1} for every grid-cell in EFForTS-ABM", "mean of all p_habitat_quality values"),
Pass = c("yes", "yes", "yes", "yes", "yes", "yes", "yes", "yes", "yes")
)
#Create table
pander::pander(unittest, caption = 'Table A: **Individual tested processes, input values for each tested process, expected output for each tested process and verification of correct implementation**. Sorry, have to find a way in R how to generate nicer tables.')
```


### Open questions:
* Include ODD-protocol for models? I would say no, because the focus is not on the models itself, but more on the connection, its realisation and the benefit.

# References:




