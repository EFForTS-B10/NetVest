---
title: "Integration of the model InVEST into the model EFForTS-ABM: new tool for dynamic simulation of biodiversity and socio-economic functions simultaneously"
author: "Julia Henzler^1^*, Nils Beyer^1^, Sebastian Hanss^1^, Craig Eric Simpkins^2^, Jan Salecker^3^, Kerstin Wiegand^1^ (order has to be discussed)"
date: "4/28/2021"
bibliography: "C:/Users/JuliaHenzler/Documents/5_GitHub/EFForTS-ABM/04_Manuscripts/05_EFForTS-ABM_SoftwareConnection/IntegrationPaper.bib" 
output: word_document
always_allow_html: true
---

# Methods
**Integration of InVEST into EFForTS-ABM**

For the simultaneous simulation of biodiversity and socio-economic functions we connected two already existing models. 

The static production function model InVEST-Terrestrial Biodiversity (Version 3.9, Tier 1) was used to simulate biodiversity. It is spatially-explicit and calculates a grid cell-level degradation score for every grid cell which was assigned habitat. The calculation is based on an user-defined land use and land cover (LULC) map, on user-defined impacts to biodiversity and on location and distance of grid cells to impacts. This degradation score is than standardized to a grid cell-level habitat quality score (Figure 1). The habitat quality score is used as a proxy for biodiversity based on a simple habitat-analysis, which enables a rapid assessment of biodiversity patterns. InVEST is a proven and widely applied software tool for simulation of biodiversity and ecological functions based on spatially-explicit maps. A detailed user guide was published in @sharp_r_invest_nodate.

<br>
    
![Figure 1: **InVEST-Terrestrial Biodiversity.** Calculation of grid cell-level degradation score and grid cell-level habitat quality score.](figures/png/InVEST.png)

<br>

The dynamic land-use change model EFForTS-ABM (Version xy) was used to simulate the socio-economic part. The initial landscapes for EFForTS-ABM are generated with the landscape generator EFForTS-LGraf. Landscapes are comprised of regular grid cells of 100 x 100 cells with a dimension of 50 m x 50 m, summing up a total landscape dimension of 25km^2^. They represent a forested landscape in Sumatra (Indonesia) with roads and villages of smallholder farming household agents and agricultural fields (oilpalm and rubber) owned and farmed by individual households. Every year households take rational land-use decisions with the aim to maximize their economic benefit (Figure 1). A detailed description of EFForTS-LGraf and EFForTS-ABM was published in @salecker_efforts-lgraf_2019 and @dislich_land-use_2018, respectively. EFForTS-ABM is able to investigate how decisions of smallholders affect economic (e.g. household consumption) functions and landscape structure from local to landscape scale and vice versa at various points in time. It comprises a spatially-explicit landscape with assignment of land use (management) and land cover (oilpalm, rubber, forest, village) to each grid cell. The impacts (either land use or land cover) to biodiversity can easliy be derived from EFForTS-ABM. Therefore, EFForTS-ABM fits requirements for dynamically generate the input for InVEST and dynamically process the output of InVEST. 
  

![Figure 1: **EFForTS-ABM.** Yearly land-use and land management decision of households.](figures/png/Economic_simple.png)

<br>

The implementation of both models was achieved by an Input-Output-Transfer. We mapped the output of EFForTS-ABM to input InVEST and mapped the output InVEST to input EFForTS-ABM. First, EFForTS-ABM generates the input - the LULC-map and one impact-map for each defined impact in tif-format and a corresponding sensitivity-table and impact-table in csv-format.
Second, InVEST integrates the generated input of EFForTS-ABM and calculates the habitat-degradation-map and habitat-quality-map in tif-format for further processing in EFForTS-ABM (Figure 3). For transferring of maps, we included an converter, as EFForTS-ABM is only able to process asc-format and InVEST is only able to process tif-format.


![Figure 3: **Input-Output-Transfer between EFForTS-ABM and InVEST**. The input of InVEST (LULC-map, Impact-map, Sensitivity-table, Impact-table) are generated by EFForTS-ABM. The input of EFForTS-ABM (Habitat-Degradation-map, Habitat-Quality-map) are generated by InVEST.](figures/png/Input-Output-Transfer.png)

<br>

**Evaluation of integration of InVEST into EFForTS-ABM**

For evaluation of the integration of the static production function model InVEST into the dynamic land-use change model EFForTS-ABM, we designed a requirement plan [@bashar_requirements_2000], which is a proven and widely applied software testing system. It is divided into functional and non-functional requirements.

The functional requirements include an testing scheme beginning from uni-tests to integration-tests and ending with an acceptance-test [@a_contan_test_2018].
Unit-tests were applied to verify the correct implementation of functions. This was realized by an isolated unit-testing modul within the model EFForTS-ABM. It comprised each particular function implemented via the connection of EfforTS-ABM and InVEST. We compared the simulated output of each particular function separately to its expected output.
Integration-tests were applied to verify the correct integration of InVEST into EFForTS-ABM. This could be proven by correct Input-Output-Processing. It was realized by an isolated integration-testing modul within the model EFForTS-ABM. For more convenient comparison of results, we chose a simplified parameter setting (see table 1 and table 2) with a binary approach for habitat-assignment and a binary approach for sensitivity of LULC-types to impacts. For the same reasons two simplified landscapes - forest-landscape and single-field-landscape - were generated. First, the simulated grid cell-level habitat quality scores of the forest-landscape were compared to the expected output to verify the correct calculation of habitat-quality scores. Second, the simulated grid cell-level habitat-quality scores of the one-field-landscape were compared to the expected output to verify the correct reduction of habitat quality scores by the defined impacts.  

<br>

```{r sensitivty table,echo=FALSE}
#Create dataframe from txt file
sensitivity <- read.table("tables\\sensitivitytable_integrationtest.txt", header = TRUE)
sens <- data.frame(sensitivity)

#Create table
knitr::kable(sens, caption = 'Table 1: **Sensitivity table.** Classification (LULC) and names (NAMES) of LULC-types and their correspoding habitat assignment (HABITAT) and sensitivities to defined impacts (L_oilpalm, L-rubber). ')
```

<br>

```{r impact table,echo=FALSE}
#Create dataframe from txt file
impact <- read.table("tables\\impacttable_integrationtest.txt", header = TRUE)
imp <- data.frame(impact)

#Create table
knitr::kable(imp, caption = 'Table 2: **Impact table.** Maximal distance of each impact over space (MAX_DIST in 50 m), its corresponding impact weighting (WEIGHT) and how impacts decay over space (DECAY). ')
```

<br>

The acceptance-test was applied to verify the dynamic simulation of socio-economic functions and biodiversity simultaneously. This test represents a constant price scenario without learning and without any landmarket. The landscape is parameterized with data from a lowland rainforest transformation system in Sumatra, Indonesia. Parameter setting for InVEST is shown in table 1 and 2. Parameter setting for EFForTS-ABM is shown in table 3. The household consumption of all households was analyzed for socio-economic-functions. The landscape-level habitat quality score by aggregation of all grid cell-level habitat quality scores, was analyzed for biodiversity.
Each test was executed with the R package nlrx [@salecker_nlrx_2019]

<br>

``` {r Parameter setting EFForTS-ABM, echo=FALSE}
#Create dataframe
para_efforts <- data.frame(Parameters = c("Prices", "Learning", "Inefficiency", "which-map", "land-use-change-decision", "initial-wealth-distribution", "landmarket", "biodiv_plants", "biodiv_plants_objective"),
                 Value = c("constant prices", "no learning", "no inefficiency", "five-farmers2", "only-one-field-per-year", "constant", "no landmarket", "invest_pyhton", "general")
                 )

#Create table
knitr::kable(para_efforts, caption = 'Table 3: **Parameter setting for EFForTS-ABM** (Maybe move to Supplementary Materials. ')
```

The non-functional requirements include the reproducibility of the integrated EFForTS-ABM-InVEST software tool. Simulations can be executed on a linux-server or on a high-performance-cluster. For the execution of the simulations on a server, we designed a repository [https://github.com/nilsbeyer/rstudio-docker]. It includes a setup instruction and a dockerfile with the correct version of InVEST and its required dependencies along with an R-Studio-Server for execution of simulations. *Also describe in detail the setup etc, which is listed in repository?*
For the execution of the simulations on a high-performance-cluster, we designed a singularity container, which duplicates the dockerfile into a singularityfile on the cluster. *Here, we have to wait for further progress. Actually, there is no function within cluster_mq to run a singularity container on the hpc. We opened an issue and wait for response. If there is no convenient way to run singularity on hpc, we have to work with an manual installation of InVEST on the cluster.*



# References
